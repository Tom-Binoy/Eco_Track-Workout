# Eco Track - Architecture

**Last Updated:** Feb 12, 2026  
**Purpose:** Document how the app works (for Windsurf and your future self)

---

## High-Level Overview

```
User (Phone/Browser)
    ↓
React App (Vercel)
    ↓
Convex (Backend + DB)
    ↓
Gemini API (AI Parsing)
```

**Data Flow:**
1. User types "Did 20 pushups"
2. React → Convex mutation
3. Convex → Gemini API (parse workout)
4. Gemini returns structured data
5. Convex saves to DB
6. React updates UI (real-time)

---

## Tech Stack

### Frontend
- **Framework:** React 18 + TypeScript
- **Styling:** Tailwind CSS + shadcn/ui
- **State:** React hooks (local) + Convex (server)
- **Hosting:** Vercel (auto-deploy from Git)

### Backend
- **Database:** Convex (serverless)
- **Auth:** Convex Auth (Google OAuth)
- **Functions:** Convex mutations/queries

### AI
- **Model:** Gemini API (Google)
- **Purpose:** Parse natural language → structured workout data
- **Fallback:** If Gemini fails, save raw text + ask user to retry

### Tools
- **Package Manager:** npm
- **Version Control:** Git + GitHub
- **IDE:** Windsurf (for AI-assisted coding)
- **Design:** v0.dev (UI generation)

---

## File Structure

```
eco-track/
├── convex/                 # Backend (Convex functions)
│   ├── schema.ts          # Database schema
│   ├── workouts.ts        # Workout mutations/queries
│   ├── auth.config.ts     # Auth setup
│   └── ai.ts              # Gemini API integration
│
├── src/
│   ├── components/
│   │   ├── chat/
│   │   │   ├── ChatContainer.tsx       # Main chat UI
│   │   │   ├── ChatMessage.tsx         # Single message bubble
│   │   │   ├── ChatInput.tsx           # Input area + send button
│   │   │   └── ChatHistory.tsx         # Past conversations
│   │   │
│   │   ├── workout/
│   │   │   ├── WorkoutCard.tsx         # Display workout summary
│   │   │   ├── WorkoutList.tsx         # History sidebar
│   │   │   └── ReviewWizard.tsx        # Confirm before saving
│   │   │
│   │   └── ui/                         # shadcn components
│   │       ├── button.tsx
│   │       ├── input.tsx
│   │       ├── card.tsx
│   │       └── sheet.tsx
│   │
│   ├── hooks/
│   │   ├── useChat.ts                  # Chat state management
│   │   ├── useWorkouts.ts              # Fetch workout history
│   │   └── useAuth.ts                  # Auth state
│   │
│   ├── lib/
│   │   ├── ai/
│   │   │   ├── parser.ts               # Parse AI response
│   │   │   └── prompts.ts              # AI prompt templates
│   │   │
│   │   ├── utils/
│   │   │   ├── formatters.ts           # Format dates, numbers
│   │   │   └── validators.ts           # Input validation
│   │   │
│   │   └── convex.ts                   # Convex client setup
│   │
│   ├── types/
│   │   ├── workout.ts                  # Workout data types
│   │   ├── chat.ts                     # Chat message types
│   │   └── user.ts                     # User profile types
│   │
│   ├── App.tsx                         # Root component
│   └── main.tsx                        # Entry point
│
├── public/
│   ├── eco-avatar.png                  # AI avatar image
│   └── favicon.ico
│
├── rules.md                            # Coding standards (for Windsurf)
├── plans.md                            # Current sprint plan
├── architecture.md                     # This file
└── README.md                           # Project overview
```

---

## Data Models

### Workout Entry
```typescript
{
  _id: string              // Auto-generated by Convex
  userId: string           // User who logged it
  createdAt: number        // Timestamp
  exercises: [
    {
      name: string         // "Pushups"
      sets?: number        // 3
      reps?: number        // 20
      weight?: number      // 50 (kg)
      duration?: number    // 30 (seconds)
      distance?: number    // 5 (km)
      notes?: string       // "Felt strong today"
    }
  ]
  rawInput: string         // Original user message
  aiResponse: string       // What AI replied
}
```

### Chat Message
```typescript
{
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: number
  workoutId?: string       // If message resulted in workout save
}
```

### User Profile
```typescript
{
  _id: string
  email: string
  name?: string
  createdAt: number
  preferences?: {
    units: 'kg' | 'lbs'
    reminderTime?: string  // Future feature
  }
}
```

---

## Core Flows

### 1. Log a Workout

```
[User types message]
        ↓
ChatInput.onSend()
        ↓
useChat.sendMessage()
        ↓
Convex.mutation("workouts:create")
        ↓
Call Gemini API (parse message)
        ↓
Extract exercises from AI response
        ↓
Save to Convex database
        ↓
Return workout ID + AI response
        ↓
Update React state (show AI reply)
        ↓
[User sees confirmation]
```

**Error Handling:**
- If Gemini fails → Save raw text + ask user to clarify
- If network fails → Show toast "Connection issue, try again?"
- If duplicate detected → Ask "Log this again or was that a mistake?"

---

### 2. View History

```
[User clicks "History"]
        ↓
Open Sheet sidebar (shadcn)
        ↓
useWorkouts.fetch()
        ↓
Convex.query("workouts:getRecent", { limit: 30 })
        ↓
Fetch from database (filtered by userId)
        ↓
Return array of workouts
        ↓
Render WorkoutList component
        ↓
[User sees past workouts by date]
```

**Interactions:**
- Click workout → Expand to see exercises
- Long-press → Delete workout (with confirmation)

---

### 3. Authentication

```
[User opens app]
        ↓
Check Convex auth state
        ↓
If logged in → Load user data
If not → Show login modal
        ↓
[User clicks "Login with Google"]
        ↓
Convex OAuth flow (redirects)
        ↓
Google consent screen
        ↓
Redirect back to app
        ↓
Convex creates/fetches user
        ↓
Store auth token (localStorage)
        ↓
[User sees chat interface]
```

---

## AI Integration

### Prompt Template
```
System: You are Eco, a friendly AI workout tracker.

Context:
- User's last 3 workouts: [...]
- User's typical exercises: [...]

User Message: "{user input}"

Instructions:
1. Parse the workout (exercises, sets, reps, weight)
2. Respond in under 10 words
3. Be encouraging, never judgmental
4. Ask only critical missing info (e.g., "How many sets?")

Response Format:
{
  "exercises": [...],
  "reply": "Nice! Same as last time?"
}
```

### Context Loading
- Load last 3 workouts (max 1000 tokens)
- Include exercise names only (not full details)
- If user has <3 workouts, include onboarding context

### Response Parsing
```typescript
function parseAIResponse(aiOutput: string) {
  try {
    const data = JSON.parse(aiOutput)
    return {
      exercises: data.exercises,
      reply: data.reply
    }
  } catch {
    // Fallback: extract manually with regex
    return extractExercisesFromText(aiOutput)
  }
}
```

---

## State Management

### Local State (React)
- Chat messages (ephemeral)
- Input field value
- Loading states (isLoading, isSending)
- UI toggles (sidebar open/closed)

### Server State (Convex)
- Workouts (database)
- User profile (database)
- Auth status (Convex Auth)

**Pattern:**
```tsx
// ✅ Correct: Use Convex for DB data
const workouts = useQuery(api.workouts.getRecent)

// ❌ Wrong: Don't store DB data in React state
const [workouts, setWorkouts] = useState([])
```

---

## API Costs (Estimated)

### Gemini API
- **Cost:** ~£0.001 per message (1-2k tokens)
- **Usage:** 5 messages/day per user = £0.005/day
- **Monthly (1 user):** ~£0.15/month
- **Monthly (100 users):** ~£15/month

### Convex
- **Free Tier:** Up to 1M function calls/month
- **Estimated:** <100k calls/month for 100 users
- **Cost:** £0

### Vercel
- **Hosting:** Free (hobby plan)
- **Bandwidth:** Free (under 100GB/month)

**Total Beta Cost:** £5-20/month (mostly Gemini API)

---

## Performance Targets

### Load Times
- **Initial load:** <2 seconds
- **Chat message send:** <1 second (perceived)
- **History fetch:** <500ms

### Mobile
- **First Contentful Paint:** <1.5 seconds
- **Time to Interactive:** <3 seconds

**Optimizations:**
- Lazy load history (don't fetch until opened)
- Cache chat context (don't re-fetch on every message)
- Compress images (use WebP, <100KB)

---

## Security

### Current
- ✅ HTTPS only (Vercel default)
- ✅ Auth tokens (Convex Auth handles)
- ✅ User data isolation (Convex queries filtered by userId)

### Missing (Add Later)
- ❌ Rate limiting (prevent spam)
- ❌ Input sanitization (before AI prompts)
- ❌ API key rotation (if leaked)

**Critical:** Never commit `.env.local` to Git (contains API keys)

---

## Deployment

### Development
```bash
npm run dev              # Start local dev server
npm run convex:dev       # Start Convex backend
```

### Production
```bash
git push origin main     # Auto-deploys to Vercel
npm run convex:deploy    # Deploy Convex functions
```

**Environments:**
- `main` branch → Production (eco-track.vercel.app)
- `dev` branch → Staging (eco-track-dev.vercel.app)

---

## Known Issues (As of Feb 12)

1. **Code is messy** → Needs refactor (Week 1 task)
2. **No error handling** → Fails silently on network errors
3. **Mobile not responsive** → Breaks on small screens
4. **No loading states** → Blank screen while AI processes
5. **Context memory missing** → AI doesn't remember past workouts

**All addressed in `plans.md` (5-week roadmap)**

---

## Future Architecture (Post-Beta)

### Voice Input
- Add Web Speech API (browser native)
- Fallback to Whisper API if quality issues

### Analytics
- Add Convex table for events (workout_logged, history_viewed)
- Build dashboard with Recharts

### Premium Tier
- Upgrade to GPT-4 for Pro users
- Store tier in User model (free/pro)
- Gate features in Convex queries

---

## Questions for Future

1. **Offline support?** (PWA + local storage)
2. **Social features?** (share workouts with friends)
3. **Wearable integration?** (Apple Watch, Garmin)
4. **Export data?** (CSV download, Google Sheets)

**Decision:** Not now. Focus on core loop (logging) first.

---

End of architecture.md
